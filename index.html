<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14">
  <title>CEFS Manlleu Â· RÃ dio en directe</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --prim:#f7b500; --sec:#d21f3c; --bg:#0b0f14; --card:#101722;
      --text:#eef2f5; --muted:#9fb0c3; --ok:#2ad37a; --warn:#ffb703; --err:#ff5d5d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1200px 600px at 80% -10%, #1b2533 0%, transparent 60%),
        radial-gradient(900px 500px at 0% 100%, #121b27 0%, transparent 60%),
        linear-gradient(180deg,#0a0e13 0%, #0b111a 100%);
      color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(900px,92vw); border-radius:20px;
      background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:0 20px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(8px); overflow:hidden;
    }
    .header{
      display:flex; gap:16px; align-items:center; padding:20px 22px; border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(90deg, rgba(242,185,0,.18), rgba(210,31,60,.18));
    }
    .logo{ width:64px; height:64px; border-radius:14px; background:#111; display:grid; place-items:center; overflow:hidden;
      border:3px solid #fff2; box-shadow:0 8px 20px rgba(0,0,0,.25) }
    .logo img{width:100%; height:100%; object-fit:cover}
    .titles{line-height:1.1}
    .club{font-family:Montserrat,Inter,sans-serif; font-weight:800; letter-spacing:.3px; font-size:1.4rem}
    .subtag{font-weight:600; color:var(--muted); font-size:.95rem; display:flex; align-items:center; gap:.5rem}

    .now{ padding:18px 22px; display:flex; align-items:center; gap:14px; border-bottom:1px solid rgba(255,255,255,.06) }
    .dot{width:10px; height:10px; border-radius:50%; background:var(--ok); box-shadow:0 0 12px var(--ok)}
    .song{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; font-weight:600}
    .label{color:var(--muted); font-weight:600}

    .player{ padding:22px; display:grid; grid-template-columns: 1fr auto; gap:22px; align-items:center }
    .controls{display:flex; align-items:center; gap:16px; flex-wrap:wrap}
    .btn{
      width:74px; height:74px; border:none; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffe9 40%, #fff0 41%), linear-gradient(135deg, var(--prim), var(--sec));
      color:#111; font-weight:800; font-size:0; cursor:pointer; position:relative;
      box-shadow:0 10px 30px rgba(210,31,60,.35), 0 8px 14px rgba(247,181,0,.25);
      transition: transform .08s ease;
    }
    .btn:active{ transform: scale(.98) }
    .btn .icon{ position:absolute; inset:0; display:grid; place-items:center }
    .btn .play{ width:0; height:0; border-left:20px solid #111; border-top:12px solid transparent; border-bottom:12px solid transparent; margin-left:6px}
    .btn .pause{ display:none; width:20px; height:20px}
    .btn .pause::before, .btn .pause::after{ content:""; display:block; width:6px; height:20px; background:#111; border-radius:2px; box-shadow:8px 0 0 #111 }
    .btn.playing .play{display:none}
    .btn.playing .pause{display:block}

    .eq{ display:flex; gap:6px; align-items:flex-end; height:48px; padding:0 4px }
    .bar{ width:6px; background: linear-gradient(180deg, var(--prim), var(--sec)); border-radius:3px; opacity:.9;
      animation: bounce 1.2s infinite ease-in-out; transform-origin: bottom }
    .bar:nth-child(2){ animation-delay:.1s } .bar:nth-child(3){ animation-delay:.2s }
    .bar:nth-child(4){ animation-delay:.3s } .bar:nth-child(5){ animation-delay:.4s }
    @keyframes bounce{ 0%,100%{ height:14% } 40%{ height:90% } 70%{ height:35% } }

    .vol{ display:flex; align-items:center; gap:10px; min-width:220px; color:var(--muted); font-weight:600 }
    input[type="range"]{-webkit-appearance:none; width:190px; height:6px; border-radius:8px; background:#ffffff25; outline:none}
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
      background: linear-gradient(135deg,var(--prim),var(--sec)); border:2px solid #fff9; box-shadow:0 2px 8px rgba(0,0,0,.35)
    }

    .right{ text-align:right; color:var(--muted); font-weight:600 }
    .footer{ padding:16px 22px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:.92rem }
    .err{ color:var(--err); font-weight:700 }
  </style>

  <!-- Widget oficial de SonicPanel (rellena #sonic_* cada ~10s) -->
  <script id="sonic_js"
          data-host="sonic2.sistemahost.es"
          data-port="8120"
          data-ssl="true"
          src="https://sonic2.sistemahost.es/cp/widgets.js?v=456"></script>
</head>
<body>

  <!-- Campos ocultos que rellena el widget -->
  <div id="sonic_title" style="display:none"></div>
  <div id="sonic_listeners" style="display:none"></div>
  <div id="sonic_art" style="display:none"></div>

  <div class="card">
    <!-- CapÃ§alera -->
    <div class="header">
      <div class="logo">
        <img id="logo" src="https://files.fcf.cat/escudos/clubes/escudos/00100_0000653585_manlleufs_200x200.png" alt="CEFS Manlleu" onerror="this.style.display='none'">
      </div>
      <div class="titles">
        <div class="club">CEFS MANLLEU</div>
        <div class="subtag" id="subtag">ðŸŽµ Carregantâ€¦</div>
      </div>
    </div>

    <!-- Ara sona -->
    <div class="now">
      <div class="dot" id="liveDot" title="en directe"></div>
      <div class="label">Ara sona:</div>
      <div class="song" id="nowSong"><strong>Carregant pistaâ€¦</strong></div>
    </div>

    <!-- Controls -->
    <div class="player">
      <div class="controls">
        <button class="btn" id="playBtn" aria-label="Reprodueix / Pausa">
          <span class="icon"><span class="play"></span><span class="pause"></span></span>
        </button>
        <div class="eq" aria-hidden="true">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div class="vol">
          ðŸ”Š Volum
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
        </div>
      </div>
      <div class="right">
        Estat: <span id="state">Parat</span>
      </div>
    </div>

    <div class="footer">
      <span>Codec: MP3 Â· 128 kbps (recomanat)</span>
      <span>Â© CEFS Manlleu</span>
    </div>
  </div>

  <!-- Ã€udio -->
  <audio id="radio" preload="none" crossorigin="anonymous"></audio>

  <script>
    /* ========= CONFIG ========= */
    const STREAM_URL     = "https://sonic2.sistemahost.es:7059/stream"; // SSL
    const ICECAST_STATUS = "https://sonic2.sistemahost.es:7059/status-json.xsl"; // fallback
    const SHOUT_STATS    = "https://sonic2.sistemahost.es:8120/stats?json=1";     // fallback alt.
    /* ========================= */

    // DOM
    const audio   = document.getElementById('radio');
    const playBtn = document.getElementById('playBtn');
    const vol     = document.getElementById('vol');
    const state   = document.getElementById('state');
    const nowSong = document.getElementById('nowSong');
    const subtag  = document.getElementById('subtag');
    const liveDot = document.getElementById('liveDot');
    const listenersEl = document.getElementById('liveListeners');

    // Setup
    audio.src = STREAM_URL;
    audio.volume = parseFloat(vol.value);

    function setDotColor(cssVar){
      const val = getComputedStyle(document.documentElement).getPropertyValue(cssVar) || cssVar;
      liveDot.style.background = val;
      liveDot.style.boxShadow = `0 0 12px ${val}`;
    }

    // Play/Pause
    playBtn.addEventListener('click', async () => {
      if (audio.paused) {
        try {
          await audio.play();
          playBtn.classList.add('playing');
          state.textContent = 'En reproducciÃ³';
          setDotColor('--ok');
        } catch (e) {
          state.innerHTML = '<span class="err">PermÃ­s de reproducciÃ³ requerit</span>';
          console.warn(e);
        }
      } else {
        audio.pause();
        playBtn.classList.remove('playing');
        state.textContent = 'Pausat';
        setDotColor('--warn');
      }
    });

    // Events
    vol.addEventListener('input', () => audio.volume = parseFloat(vol.value));
    audio.addEventListener('waiting', () => { state.textContent = 'Buferejantâ€¦'; setDotColor('--warn'); });
    audio.addEventListener('playing', () => { state.textContent = 'En reproducciÃ³'; setDotColor('--ok'); });
    audio.addEventListener('pause',   () => { state.textContent = 'Pausat'; setDotColor('--warn'); });
    audio.addEventListener('error',   () => { state.innerHTML = '<span class="err">Error de reproducciÃ³</span>'; setDotColor('--err'); });

    /* ====== NOW PLAYING (widget + fallbacks) ====== */
    function readFromWidget(){
      const t  = document.getElementById('sonic_title')?.textContent?.trim();
      const ls = document.getElementById('sonic_listeners')?.textContent?.trim();
      return { title: t || "", listeners: ls || "" };
    }

    async function fetchIcecast(){
      try{
        const r = await fetch(ICECAST_STATUS, { cache:'no-store' });
        const d = await r.json();
        const src = d?.icestats?.source;
        const title = Array.isArray(src) ? (src[0]?.title || "") : (src?.title || "");
        const listeners = Array.isArray(src) ? (src[0]?.listeners || "") : (src?.listeners || "");
        return { title, listeners };
      }catch{ return { title:"", listeners:"" } }
    }

    async function fetchShoutcast(){
      try{
        const r = await fetch(SHOUT_STATS, { cache:'no-store' });
        const d = await r.json();
        return { title: d?.songtitle || d?.currenttrack || "", listeners: d?.currentlisteners || "" };
      }catch{ return { title:"", listeners:"" } }
    }

    async function updateNowPlaying(){
      // 1) Widget
      let { title, listeners } = readFromWidget();

      // 2) Fallbacks si vacÃ­o
      if(!title){
        ({ title, listeners } = await fetchIcecast());
      }
      if(!title){
        ({ title, listeners } = await fetchShoutcast());
      }

      if(title){
        nowSong.textContent = title;
        subtag.textContent  = 'ðŸŽµ ' + title;
      }else{
        nowSong.textContent = 'En directe';
        subtag.textContent  = 'ðŸŽµ En directe';
      }
      if(listeners && listenersEl){
        listenersEl.textContent = listeners;
      }
    }

    updateNowPlaying();
    setInterval(updateNowPlaying, 5000);
  </script>
</body>
</html>
